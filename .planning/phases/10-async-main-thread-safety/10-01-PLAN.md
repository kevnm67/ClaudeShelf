---
phase: 10-async-main-thread-safety
plan: 01
type: execute
domain: concurrency
---

<objective>
Make ExportService.exportAsZip and CleanupAnalyzer.analyze async to eliminate main thread blocking, and update all callers (views and tests) to use async/await patterns.

Purpose: Fix audit finding H-2 (ExportService blocks main thread with Process.waitUntilExit()) and move CleanupAnalyzer file I/O off the main thread. Modernize NSSavePanel callback-based callers to use async Task wrappers.
Output: Both services are async, all callers use async/await, all tests pass.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@ClaudeShelf/Services/ExportService.swift
@ClaudeShelf/Services/CleanupAnalyzer.swift
@ClaudeShelf/App/ContentView.swift
@ClaudeShelf/Views/Sidebar/FileListView.swift
@ClaudeShelf/Views/Cleanup/CleanupSheet.swift
@ClaudeShelfTests/ExportServiceTests.swift
@ClaudeShelfTests/CleanupAnalyzerTests.swift
</context>

<tasks>
<task type="auto">
  <name>Task 1: Make ExportService.exportAsZip async</name>
  <files>ClaudeShelf/Services/ExportService.swift, ClaudeShelfTests/ExportServiceTests.swift</files>
  <action>
  Convert `exportAsZip(files:to:)` from synchronous (`throws`) to async (`async throws`).

  **ExportService.swift changes:**
  1. Change signature to `static func exportAsZip(files: [FileEntry], to destination: String) async throws`
  2. Replace the blocking `process.waitUntilExit()` (line 67) with an async continuation pattern:
     - Use `withCheckedThrowingContinuation` wrapping `process.terminationHandler`
     - In the handler, check `process.terminationStatus == 0`, resume with success or throw `ExportError.zipCreationFailed`
     - Read stderr pipe data BEFORE setting the termination handler (to avoid pipe deadlock)
  3. Keep all other logic (staging, file copy, cleanup) as-is — these are fast FileManager operations

  **ExportServiceTests.swift changes:**
  1. Mark `testExportCreatesZipFile`, `testExportThrowsOnEmptyFiles`, and `testExportHandlesNameCollisions` as `async` test methods
  2. Change `try ExportService.exportAsZip(...)` to `try await ExportService.exportAsZip(...)`
  3. For the throws test, wrap in a do/catch or use an async throws assertion helper since `XCTAssertThrowsError` doesn't support async — use a do/catch with `XCTFail` on the happy path instead
  </action>
  <verify>xcodegen generate && xcodebuild build -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | tail -5</verify>
  <done>ExportService.exportAsZip is async, uses terminationHandler instead of waitUntilExit, all ExportService tests compile and pass</done>
</task>

<task type="auto">
  <name>Task 2: Make CleanupAnalyzer.analyze async</name>
  <files>ClaudeShelf/Services/CleanupAnalyzer.swift, ClaudeShelfTests/CleanupAnalyzerTests.swift</files>
  <action>
  Convert `analyze(files:)` from synchronous to async to move file I/O off the main thread.

  **CleanupAnalyzer.swift changes:**
  1. Change signature to `static func analyze(files: [FileEntry]) async -> [CleanupItem]`
  2. No other logic changes needed — the method already reads small files (<1024 bytes). Making it async allows callers to dispatch to a background context via Task.

  **CleanupAnalyzerTests.swift changes:**
  1. Mark all test methods that call `CleanupAnalyzer.analyze` as `async` (17 test methods)
  2. Add `await` before each `CleanupAnalyzer.analyze(files:)` call
  3. Keep all assertions unchanged
  </action>
  <verify>xcodebuild test -scheme ClaudeShelf -destination 'platform=macOS' -only-testing ClaudeShelfTests/CleanupAnalyzerTests 2>&1 | tail -20</verify>
  <done>CleanupAnalyzer.analyze is async, all 17 CleanupAnalyzer tests compile and pass with async/await</done>
</task>

<task type="auto">
  <name>Task 3: Update UI callers to async patterns</name>
  <files>ClaudeShelf/App/ContentView.swift, ClaudeShelf/Views/Sidebar/FileListView.swift, ClaudeShelf/Views/Cleanup/CleanupSheet.swift</files>
  <action>
  Update all view-layer callers to use async/await for the now-async services.

  **ContentView.swift — exportFiles():**
  1. Inside the `panel.begin { response in }` closure, wrap the export call in `Task { @MainActor in }` so the async export runs off the main thread but error state updates happen on MainActor
  2. Change `try ExportService.exportAsZip(...)` to `try await ExportService.exportAsZip(...)`

  **FileListView.swift — exportSelectedFiles():**
  1. Same pattern as ContentView: wrap export in `Task { @MainActor in }` inside the panel callback
  2. Change `try ExportService.exportAsZip(...)` to `try await ExportService.exportAsZip(...)`

  **CleanupSheet.swift — analyze():**
  1. Change `analyze()` to be an async function (or wrap in Task)
  2. Change `items = CleanupAnalyzer.analyze(files:)` to `items = await CleanupAnalyzer.analyze(files:)`
  3. The `.task { analyze() }` modifier already creates an async context, so `analyze()` just needs to be async
  </action>
  <verify>xcodebuild test -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | grep -E '(Test Suite|Tests? (passed|failed)|BUILD)'</verify>
  <done>All three view files use async/await for export and cleanup, full test suite passes, no main thread blocking</done>
</task>
</tasks>

<verification>
Before declaring phase complete:
- [ ] `xcodegen generate && xcodebuild build` succeeds
- [ ] `xcodebuild test` — all tests pass (89+ tests)
- [ ] ExportService.exportAsZip no longer calls process.waitUntilExit()
- [ ] CleanupAnalyzer.analyze is async
- [ ] No sync I/O on main thread in export or cleanup flows
</verification>

<success_criteria>
- ExportService.exportAsZip is async, uses Process.terminationHandler
- CleanupAnalyzer.analyze is async
- All UI callers (ContentView, FileListView, CleanupSheet) updated to async/await
- All tests pass with async test methods
- No new warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/10-async-main-thread-safety/10-01-SUMMARY.md` with:
- Duration and task count
- Files modified
- Key implementation details (terminationHandler pattern, async test migration)
- Any deviations from plan
</output>
