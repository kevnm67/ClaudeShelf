---
phase: 14-code-quality-polish
plan: 01
type: execute
domain: quality
---

<objective>
Fix logger inconsistencies, ByteCountFormatter per-row allocation, DiffLine.id nondeterminism, and ScanLocation UUID nondeterminism.

Purpose: Eliminate code quality issues found in the security audit — inconsistent logger patterns, unnecessary allocations, and nondeterministic identifiers.
Output: Consistent `private static let` loggers, efficient ByteCountFormatter, deterministic DiffLine IDs and ScanLocation UUIDs.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@ClaudeShelf/Services/FileWatcher.swift
@ClaudeShelf/Views/Editor/FileDetailView.swift
@ClaudeShelf/Views/Sidebar/FileListView.swift
@ClaudeShelf/Views/Cleanup/CleanupSheet.swift
@ClaudeShelf/Views/Sidebar/FileRowView.swift
@ClaudeShelf/Views/Editor/DiffView.swift
@ClaudeShelf/Models/ScanLocation.swift

**Constraining decisions:**
- Swift 6 strict concurrency (`SWIFT_STRICT_CONCURRENCY=complete`)
- `nonisolated(unsafe)` for static properties that can't prove Sendable (NSFont etc.)
- Logger is Sendable — `private static let` works without nonisolated(unsafe)
</context>

<tasks>
<task type="auto">
  <name>Task 1: Fix logger inconsistencies</name>
  <files>ClaudeShelf/Services/FileWatcher.swift, ClaudeShelf/Views/Editor/FileDetailView.swift, ClaudeShelf/Views/Sidebar/FileListView.swift, ClaudeShelf/Views/Cleanup/CleanupSheet.swift</files>
  <action>
  Four files have logger inconsistencies. Fix them all to use `private static let`.

  **FileWatcher.swift (line 19):**
  - Change `private let logger = Logger(...)` to `private static let logger = Logger(...)`
  - FileWatcher is an actor. `private static let` works on actors. Update all `logger.` references in the file to `Self.logger.` (since static properties on actors need `Self.` prefix when called from instance methods).

  **FileDetailView.swift (line 6):**
  - Currently a file-scope global: `private let logger = Logger(...)`
  - Move inside the `FileDetailView` struct as `private static let logger = Logger(...)`
  - Update any `logger.` references inside FileDetailView to use the static.

  **FileListView.swift (line 6):**
  - Currently a file-scope global: `private let logger = Logger(...)`
  - Move inside the `FileListView` struct as `private static let logger = Logger(...)`
  - Update any `logger.` references inside FileListView.

  **CleanupSheet.swift (line 13):**
  - Change `private let logger = Logger(...)` to `private static let logger = Logger(...)`
  - Update any `logger.` references to use the static.

  All subsystems are already "com.claudeshelf.app" and categories match the type name — no changes needed there.

  **Verify:** All 4 loggers are now `private static let` and accessible via `Self.logger` or just `logger` (Swift allows omitting `Self.` for static properties in most contexts — use `Self.` only if compiler requires it).
  </action>
  <verify>xcodegen generate && xcodebuild build -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | tail -5</verify>
  <done>All loggers are private static let with consistent subsystem and category naming</done>
</task>

<task type="auto">
  <name>Task 2: Fix ByteCountFormatter per-row allocation and DiffLine.id nondeterminism</name>
  <files>ClaudeShelf/Views/Sidebar/FileRowView.swift, ClaudeShelf/Views/Editor/DiffView.swift</files>
  <action>
  Two quick fixes in different files.

  **FileRowView.swift (lines 105-109):**
  Current code creates a new ByteCountFormatter per row:
  ```swift
  private var formattedSize: String {
      let formatter = ByteCountFormatter()
      formatter.countStyle = .file
      return formatter.string(fromByteCount: file.size)
  }
  ```
  Replace with the static factory method:
  ```swift
  private var formattedSize: String {
      ByteCountFormatter.string(fromByteCount: file.size, countStyle: .file)
  }
  ```
  This uses the shared formatter internally — no allocation per row.

  **DiffView.swift (lines 9-17):**
  Current `DiffLine.id` uses `text.hashValue` which is nondeterministic:
  ```swift
  case .unchanged(let lineNumber, let text):
      return "u-\(lineNumber)-\(text.hashValue)"
  ```
  Replace with deterministic line-number-only IDs:
  ```swift
  var id: String {
      switch self {
      case .unchanged(let lineNumber, _):
          return "u-\(lineNumber)"
      case .added(let lineNumber, _):
          return "a-\(lineNumber)"
      case .removed(let lineNumber, _):
          return "r-\(lineNumber)"
      }
  }
  ```
  The `lineNumber` is a monotonically incrementing counter from `buildDiffOutput` and is unique within each diff computation.

  **Update DiffViewTests** if any tests assert on the id format — they may need adjustment for the new format without hashValue. Check `DiffViewTests.swift` for any `.id` assertions.
  </action>
  <verify>xcodebuild test -scheme ClaudeShelf -destination 'platform=macOS' -only-testing ClaudeShelfTests/DiffViewTests 2>&1 | tail -20</verify>
  <done>ByteCountFormatter uses static method, DiffLine.id is deterministic</done>
</task>

<task type="auto">
  <name>Task 3: Make ScanLocation default UUIDs deterministic</name>
  <files>ClaudeShelf/Models/ScanLocation.swift</files>
  <action>
  Currently `ScanLocation.defaultLocations` creates new `UUID()` instances each app launch. Make them deterministic by deriving UUIDs from the path.

  Replace the map in `defaultLocations` (lines 72-79):

  ```swift
  static let defaultLocations: [ScanLocation] = {
      let home = FileManager.default.homeDirectoryForCurrentUser.path
      let paths = [
          "\(home)/.claude",
          "\(home)/projects",
          "\(home)/src",
          "\(home)/dev",
          "\(home)/code",
          "\(home)/workspace",
          "\(home)/repos",
          home,
      ]
      return paths.map { path in
          ScanLocation(
              id: stableUUID(for: path),
              path: path,
              isEnabled: true,
              isDefault: true
          )
      }
  }()
  ```

  Add a private helper that generates a UUID from the path using SHA256 (CryptoKit is already imported in FileEntry, but ScanLocation doesn't import it — add `import CryptoKit`):

  ```swift
  /// Generates a stable UUID from a string by hashing it with SHA256.
  ///
  /// Uses the first 16 bytes of the SHA256 digest to construct a UUID,
  /// ensuring the same input always produces the same UUID across launches.
  private static func stableUUID(for string: String) -> UUID {
      let data = Data(string.utf8)
      let hash = SHA256.hash(data: data)
      let bytes = Array(hash.prefix(16))
      // Construct UUID from first 16 bytes, setting version 4 and variant bits
      var uuid = bytes
      uuid[6] = (uuid[6] & 0x0F) | 0x40 // version 4
      uuid[8] = (uuid[8] & 0x3F) | 0x80 // variant 1
      return UUID(uuid: (
          uuid[0], uuid[1], uuid[2], uuid[3],
          uuid[4], uuid[5], uuid[6], uuid[7],
          uuid[8], uuid[9], uuid[10], uuid[11],
          uuid[12], uuid[13], uuid[14], uuid[15]
      ))
  }
  ```

  This ensures the same path always produces the same UUID, even across app restarts. The merge-by-path strategy in ScanLocationStore still works, but now the IDs are stable too.

  **Important:** This changes the UUIDs of default locations. Existing saved data merges by path (not ID), so this is safe — the merge strategy in ScanLocationStore.load already handles this correctly.
  </action>
  <verify>xcodebuild test -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | grep -E '(Test Suite|Tests? (passed|failed)|BUILD)'</verify>
  <done>Default ScanLocation UUIDs are deterministic, derived from path via SHA256</done>
</task>
</tasks>

<verification>
Before declaring phase complete:
- [ ] `xcodegen generate && xcodebuild build` succeeds
- [ ] `xcodebuild test` — all 149 tests pass
- [ ] All loggers use `private static let` pattern
- [ ] ByteCountFormatter uses static factory method
- [ ] DiffLine.id is deterministic (no hashValue)
- [ ] ScanLocation.defaultLocations produces stable UUIDs
</verification>

<success_criteria>
- 4 loggers fixed to private static let
- ByteCountFormatter per-row allocation eliminated
- DiffLine.id deterministic using lineNumber only
- ScanLocation default UUIDs deterministic via SHA256
- All 149 tests pass, no new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/14-code-quality-polish/14-01-SUMMARY.md` with:
- Duration and task count
- Files modified
- Quality fixes applied
- Any deviations from plan
</output>
