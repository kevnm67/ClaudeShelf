---
phase: 02-file-scanner
plan: 02
type: execute
---

<objective>
Implement category assignment with 12 priority rules and integrate all scanner components to produce complete FileEntry objects from discovered files.

Purpose: Turn raw discovered files into categorized, identified FileEntry models ready for the UI.
Output: CategoryAssigner utility and complete scan pipeline producing [FileEntry].
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-scanner/02-01-SUMMARY.md

@ClaudeShelf/Models/Category.swift
@ClaudeShelf/Models/FileEntry.swift
@ClaudeShelf/Models/Scope.swift
@ClaudeShelf/Services/FileScanner.swift
@ClaudeShelf/Utilities/PathDecoder.swift

**Category assignment rules from PROJECT.md (priority order — first match wins):**
1. Path contains `/agents/` + `.md` extension → Agents
2. Path contains `/debug/` → Debug
3. Path contains `/memory/` or file is `memory.md` → Memory
4. File is `CLAUDE.md` outside `.claude/` → Project Config
5. File is `settings.json` or `.clauderc` → Settings
6. `.sh` files inside `.claude/` (not shell-snapshots) → Settings
7. `stats-cache.json` → Settings
8. Path contains `/todos/` or `/tasks/` → Todos
9. Path contains `/plans/` → Plans
10. Path contains `/skills/` → Skills
11. File is `CLAUDE.md` or `.clauderc` → Project Config
12. Everything else → Other
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CategoryAssigner with 12 priority rules</name>
  <files>
    ClaudeShelf/Services/CategoryAssigner.swift,
    ClaudeShelf.xcodeproj/project.pbxproj
  </files>
  <action>
    Create `ClaudeShelf/Services/CategoryAssigner.swift`:

    ```
    struct CategoryAssigner: Sendable {
        /// Assigns a category to a file based on 12 priority rules.
        /// First matching rule wins (priority order).
        ///
        /// - Parameters:
        ///   - fileName: The file's name (e.g., "CLAUDE.md", "settings.json")
        ///   - path: The absolute file path
        ///   - isInsideClaude: Whether the file is inside a .claude/ directory
        /// - Returns: The assigned Category
        static func assignCategory(
            fileName: String,
            path: String,
            isInsideClaude: Bool
        ) -> Category {
            let lowercasePath = path.lowercased()
            let fileExtension = (fileName as NSString).pathExtension.lowercased()

            // Rule 1: /agents/ + .md extension → Agents
            if lowercasePath.contains("/agents/") && fileExtension == "md" {
                return .agents
            }

            // Rule 2: /debug/ → Debug
            if lowercasePath.contains("/debug/") {
                return .debug
            }

            // Rule 3: /memory/ or file is memory.md → Memory
            if lowercasePath.contains("/memory/") || fileName.lowercased() == "memory.md" {
                return .memory
            }

            // Rule 4: CLAUDE.md outside .claude/ → Project Config
            if fileName == "CLAUDE.md" && !isInsideClaude {
                return .projectConfig
            }

            // Rule 5: settings.json or .clauderc → Settings
            if fileName == "settings.json" || fileName == ".clauderc" {
                return .settings
            }

            // Rule 6: .sh files inside .claude/ (not shell-snapshots) → Settings
            if isInsideClaude && fileExtension == "sh" && !lowercasePath.contains("/shell-snapshots/") {
                return .settings
            }

            // Rule 7: stats-cache.json → Settings
            if fileName == "stats-cache.json" {
                return .settings
            }

            // Rule 8: /todos/ or /tasks/ → Todos
            if lowercasePath.contains("/todos/") || lowercasePath.contains("/tasks/") {
                return .todos
            }

            // Rule 9: /plans/ → Plans
            if lowercasePath.contains("/plans/") {
                return .plans
            }

            // Rule 10: /skills/ → Skills
            if lowercasePath.contains("/skills/") {
                return .skills
            }

            // Rule 11: CLAUDE.md or .clauderc (catch-all for inside .claude) → Project Config
            if fileName == "CLAUDE.md" || fileName == ".clauderc" {
                return .projectConfig
            }

            // Rule 12: Everything else → Other
            return .other
        }
    }
    ```

    Add to project.pbxproj under Services group. Use C2... prefix for IDs.
  </action>
  <verify>
    Run: `xcodebuild -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -configuration Debug build 2>&1 | tail -5`
    Should show BUILD SUCCEEDED.
  </verify>
  <done>
    CategoryAssigner exists with all 12 rules in priority order, compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete scan pipeline — produce FileEntry objects</name>
  <files>
    ClaudeShelf/Services/FileScanner.swift,
    ClaudeShelf.xcodeproj/project.pbxproj
  </files>
  <action>
    Update FileScanner to add a method that converts DiscoveredFile objects into FileEntry objects:

    Add to the FileScanner actor:

    ```
    /// Performs a full scan across all enabled locations and returns categorized FileEntry objects.
    func scan(locations: [ScanLocation]) async -> ScanResult {
        let startTime = Date()
        var allFiles: [FileEntry] = []
        var errors: [String] = []
        let homeDir = FileManager.default.homeDirectoryForCurrentUser.path

        for location in locations where location.isEnabled {
            let expandedPath = location.path.replacingOccurrences(of: "~", with: homeDir)
            let url = URL(fileURLWithPath: expandedPath)

            guard FileManager.default.fileExists(atPath: expandedPath) else {
                continue  // Skip non-existent locations silently
            }

            let discovered = scanDirectory(at: url, currentDepth: 0, isInsideClaude: false)

            for file in discovered {
                let category = CategoryAssigner.assignCategory(
                    fileName: file.name,
                    path: file.url.path,
                    isInsideClaude: file.isInsideClaude
                )

                let (scope, project) = PathDecoder.detectScope(
                    for: file.url.path,
                    homeDirectory: homeDir
                )

                let displayName = PathDecoder.displayName(
                    for: file.name,
                    project: project
                )

                let entry = FileEntry(
                    id: FileEntry.generateID(from: file.url.path),
                    name: file.name,
                    path: file.url.path,
                    displayName: displayName,
                    category: category,
                    scope: scope,
                    project: project,
                    size: file.size,
                    modifiedDate: file.modifiedDate,
                    isReadOnly: file.isReadOnly
                )
                allFiles.append(entry)
            }
        }

        // Deduplicate by path (same file could be found via multiple scan locations)
        var seen = Set<String>()
        allFiles = allFiles.filter { seen.insert($0.path).inserted }

        let duration = Date().timeIntervalSince(startTime)
        return ScanResult(files: allFiles, scanDate: Date(), duration: duration, errors: errors)
    }
    ```

    Also update the existing `scanLocations` method (if it exists from plan 02-01) or ensure the `scan(locations:)` method is the primary public API. Remove any duplicate methods.

    Ensure all error handling captures messages into the errors array rather than crashing.
  </action>
  <verify>
    Run: `xcodebuild -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -configuration Debug build 2>&1 | tail -5`
    Should show BUILD SUCCEEDED with no concurrency warnings.
  </verify>
  <done>
    FileScanner.scan(locations:) produces [FileEntry] with categories, scopes, project names, and IDs. Deduplication works. Compiles clean under Swift 6.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds with no errors
- [ ] CategoryAssigner handles all 12 rules in priority order
- [ ] FileScanner.scan() returns complete FileEntry objects
- [ ] Deduplication removes files found via multiple scan locations
- [ ] No concurrency warnings under Swift 6 strict mode
</verification>

<success_criteria>

- CategoryAssigner exists with 12 priority rules
- FileScanner.scan(locations:) produces complete FileEntry objects
- Path decoding, category assignment, and ID generation all integrated
- Deduplication by path works
- Ready for Plan 02-03 (AppState integration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-scanner/02-02-SUMMARY.md`
</output>
