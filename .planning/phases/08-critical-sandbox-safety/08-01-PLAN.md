---
phase: 08-critical-sandbox-safety
plan: 01
type: execute
---

<objective>
Fix the two critical blockers identified in the security audit: sandbox entitlements that prevent the app from scanning any directories, and FileWatcher actor isolation violation in deinit that causes a data race.

Purpose: Without these fixes the app cannot function (sandbox blocks all scanning) and has a latent data race (deinit accesses actor-isolated state).
Output: Working entitlements that allow file scanning, race-free FileWatcher lifecycle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@ClaudeShelf/ClaudeShelf.entitlements
@ClaudeShelf/Services/FileWatcher.swift
@ClaudeShelf/App/AppState.swift
@project.yml

**Constraining decisions:**
- Swift 6 strict concurrency (`SWIFT_STRICT_CONCURRENCY=complete`)
- `nonisolated(unsafe)` pattern used for static properties (established in Phase 1)
- Zero external dependencies — Apple frameworks only
- XcodeGen generates xcodeproj from project.yml

**Audit findings being addressed:**
- C-1: App sandbox entitlements block all file scanning — app scans `~/.claude/`, `~/projects/`, `~/src/`, etc. programmatically, which sandbox blocks
- C-2: FileWatcher deinit accesses actor-isolated `sources` dictionary from arbitrary thread — data race
</context>

<tasks>

<task type="auto">
  <name>Task 1: Disable app sandbox to allow programmatic file scanning</name>
  <files>ClaudeShelf/ClaudeShelf.entitlements</files>
  <action>
  The app must scan `~/.claude/`, `~/projects/`, `~/src/`, `~/dev/`, `~/code/`, `~/workspace/`, `~/repos/`, and `~/` programmatically on launch. This is incompatible with the macOS app sandbox — no combination of entitlements allows unprompted access to arbitrary home directory paths.

  Disable the sandbox by setting `com.apple.security.app-sandbox` to `false`. Remove the `com.apple.security.files.user-selected.read-write` entitlement (not needed without sandbox). Keep the entitlements file for future use if sandbox is re-enabled.

  Do NOT add temporary exception entitlements — they are deprecated and rejected by App Store review. Disabling sandbox is the standard approach for developer tools that need broad filesystem access (e.g., Homebrew, iTerm2, VS Code).
  </action>
  <verify>`xcodegen generate && xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -configuration Debug -destination 'platform=macOS' 2>&1 | tail -5` builds without errors</verify>
  <done>Entitlements file has sandbox disabled. App builds successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Fix FileWatcher deinit actor isolation violation</name>
  <files>ClaudeShelf/Services/FileWatcher.swift</files>
  <action>
  The `deinit` block (lines 95-99) iterates `sources` to cancel DispatchSources. Since `FileWatcher` is an `actor`, `sources` is actor-isolated state. `deinit` runs synchronously on an arbitrary thread, NOT on the actor's serial executor — this is a data race if another thread is executing an actor method that mutates `sources`.

  Fix approach: Store the DispatchSources in a `nonisolated(unsafe)` container that `deinit` can safely access, OR (simpler) remove the `deinit` entirely and rely on the existing `stop()` / `stopAll()` method which already cancels all sources and runs on the actor.

  **Preferred fix — remove deinit:** The `stopAll()` method (lines 67-74) already cancels all sources and closes file descriptors via the cancel handler. When the actor is deallocated, any remaining DispatchSources will be cancelled by the system when their strong references are released. The `setCancelHandler` (line 49-51) already calls `close(fd)`, so file descriptors are properly cleaned up. The explicit deinit is redundant AND unsafe.

  Remove the entire `deinit` block. The DispatchSource cancel handlers already ensure proper cleanup.

  Do NOT use `Task { await self.stop() }` in deinit — creating a Task in deinit that captures `self` is undefined behavior since `self` is being deallocated.
  </action>
  <verify>`xcodegen generate && xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -configuration Debug -destination 'platform=macOS' 2>&1 | tail -5` builds without errors. `xcodebuild test -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | grep -E '(Test Suite|Executed|FAILED)'` — all tests pass including FileWatcherTests.</verify>
  <done>FileWatcher has no deinit block. All existing tests pass. No actor isolation warnings from strict concurrency.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodegen generate` succeeds
- [ ] `xcodebuild build` succeeds without errors or warnings
- [ ] `xcodebuild test` passes all tests (including FileWatcherTests)
- [ ] Entitlements file has `com.apple.security.app-sandbox` set to `false`
- [ ] FileWatcher.swift has no `deinit` block
- [ ] No new Swift strict concurrency warnings
</verification>

<success_criteria>

- Sandbox disabled in entitlements — app can scan filesystem on launch
- FileWatcher deinit data race eliminated
- All existing tests pass
- Build clean with no warnings
</success_criteria>

<output>
After completion, create `.planning/phases/08-critical-sandbox-safety/08-01-SUMMARY.md`
</output>
