---
phase: 09-security-hardening
plan: 01
type: execute
---

<objective>
Eliminate TOCTOU race in file save, add symlink loop protection in the scanner, and sanitize error messages to prevent raw path leakage to users.

Purpose: Close the remaining High and Medium security findings from the audit.
Output: Atomic permission-preserving save, symlink-safe scanner, sanitized user-facing errors.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@ClaudeShelf/Services/FileOperations.swift
@ClaudeShelf/Services/FileScanner.swift
@ClaudeShelf/App/ContentView.swift
@ClaudeShelf/Views/Sidebar/FileListView.swift

**Constraining decisions:**
- Swift 6 strict concurrency
- Zero external dependencies
- FileOperations uses `String.write(toFile:atomically:encoding:)` which writes to temp then renames — permissions reset to umask default during swap
- FileScanner does NOT check `.isSymbolicLinkKey` — symlinks followed blindly
- Error messages at ContentView:94 and FileListView:236 pass raw `error.localizedDescription`

**Audit findings being addressed:**
- H-1: TOCTOU race in saveFile — files briefly world-readable between atomic write and permission restore
- M-5 (symlinks): Scanner follows symlinks without detection, enabling loops and boundary escape
- M-9 (error leaking): Raw error descriptions shown to users may contain filesystem paths
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TOCTOU race in FileOperations.saveFile with atomic permission write</name>
  <files>ClaudeShelf/Services/FileOperations.swift</files>
  <action>
  The current `saveFile` method uses `String.write(toFile:atomically:encoding:)` which creates a temp file, writes to it, then atomically renames it over the original. The renamed file inherits the umask default permissions (typically 0644), NOT the original file's permissions. There is a window between the rename and the subsequent `setAttributes` call where the file is world-readable.

  Fix by replacing the write+setAttributes pattern with `FileManager.createFile(atPath:contents:attributes:)` which sets content and permissions in a single call. However, `createFile` is NOT atomic (it overwrites in-place). Instead, use this approach:

  1. Read the original file's POSIX permissions (existing code, keep)
  2. Write content to a temporary file in the same directory (using `UUID().uuidString` suffix)
  3. Set the correct permissions on the temp file BEFORE it replaces the original
  4. Use `FileManager.replaceItem(at:withItemAt:backupItemName:options:resultingItemURL:)` to atomically swap — this preserves the permissions already set on the replacement file

  This eliminates the TOCTOU window: the temp file has correct permissions BEFORE it becomes visible at the original path.

  Apply the same fix to `createFile` — currently it writes content then sets permissions, leaving a window. Instead: write to temp, set 0600 on temp, move to final path.

  Do NOT use `Data.write(to:options:)` with `.atomic` — it has the same umask problem as `String.write`.
  </action>
  <verify>`xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -configuration Debug -destination 'platform=macOS' 2>&1 | tail -3` builds without errors. `xcodebuild test -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | grep -E '(Executed|FAILED)'` — all tests pass.</verify>
  <done>saveFile and createFile both write to temp file, set permissions on temp, then atomically replace. No window where file has wrong permissions.</done>
</task>

<task type="auto">
  <name>Task 2: Add symlink protection to FileScanner</name>
  <files>ClaudeShelf/Services/FileScanner.swift</files>
  <action>
  The scanner currently does not check for symlinks. It could follow symlinks that loop back to parent directories or escape scan boundaries.

  1. Add `.isSymbolicLinkKey` to the `URLResourceKey` array used in `contentsOfDirectory(at:includingPropertiesForKeys:)`
  2. After getting resource values for each item, check `resourceValues.isSymbolicLink == true` and `continue` (skip) if so. Log at debug level.
  3. As a defense-in-depth measure, add a `visited: Set<String>` parameter (tracking resolved canonical paths) to the recursive scan function. Before entering any directory, resolve its real path with `URL.resolvingSymlinksInPath()` and check if it's already in `visited`. If so, skip it (cycle detected). Add the resolved path to `visited` before recursing.

  Do NOT use inode-based tracking — `URL.resolvingSymlinksInPath()` + canonical path string comparison is simpler and sufficient. The `visited` set should be passed through the recursion, not stored as actor state.

  Keep the existing depth limit as an additional safeguard.
  </action>
  <verify>`xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -configuration Debug -destination 'platform=macOS' 2>&1 | tail -3` builds. `xcodebuild test -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | grep -E '(Executed|FAILED)'` — all tests pass.</verify>
  <done>Scanner skips symlinks and detects directory cycles via canonical path tracking. Existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 3: Sanitize error messages in export error display</name>
  <files>ClaudeShelf/App/ContentView.swift, ClaudeShelf/Views/Sidebar/FileListView.swift</files>
  <action>
  Two locations pass raw `error.localizedDescription` to user-facing alerts:
  - `ContentView.swift` line 94: `exportError = error.localizedDescription`
  - `FileListView.swift` line 236: `exportError = error.localizedDescription`

  Replace both with a safe generic message. The pattern should be:

  ```swift
  exportError = "Unable to export files. Please try again."
  ```

  The detailed error is already logged via os_log elsewhere. Users should never see raw filesystem paths in error dialogs.

  Do NOT create a utility function for this — it's just 2 call sites with a simple string replacement. Avoid over-engineering.
  </action>
  <verify>Grep for `error.localizedDescription` in ContentView.swift and FileListView.swift near export — should find no matches in user-facing assignment context. Build succeeds.</verify>
  <done>No raw error descriptions exposed to users in export flow. Both sites use generic safe message.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodegen generate` succeeds
- [ ] `xcodebuild build` succeeds without errors
- [ ] `xcodebuild test` passes all tests
- [ ] FileOperations.saveFile writes to temp with correct permissions before replacing
- [ ] FileOperations.createFile writes to temp with 0600 before moving to final path
- [ ] FileScanner skips symlinks and tracks visited directories
- [ ] No raw error.localizedDescription in user-facing export error alerts
</verification>

<success_criteria>

- TOCTOU window eliminated — permissions set before file becomes visible
- Symlinks skipped in scanner, cycle detection via canonical path tracking
- User-facing errors are generic and safe
- All existing tests pass
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-security-hardening/09-01-SUMMARY.md`
</output>
