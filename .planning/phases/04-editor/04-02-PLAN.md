---
phase: 04-editor
plan: 02
type: execute
---

<objective>
Add regex-based syntax highlighting for Markdown, JSON, YAML, and TOML config files.

Purpose: Claude config files come in 4 formats — highlighting makes them easier to read and edit. Regex-based coloring via NSTextStorageDelegate is lightweight and requires no external parsers.
Output: SyntaxHighlighter utility that detects file type from extension and applies colored NSAttributedString styling as the user types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/04-editor/04-01-SUMMARY.md

# Key source files:
@ClaudeShelf/Views/Editor/CodeEditorView.swift
@ClaudeShelf/Views/Editor/FileDetailView.swift
@ClaudeShelf/Models/FileEntry.swift

**Tech stack available:** SwiftUI, AppKit (NSTextView, NSTextStorage, NSAttributedString), Swift 6
**Established patterns:** NSViewRepresentable, NSTextViewDelegate in Coordinator, LineNumberRulerView
**Constraining decisions:**
- [04-01]: CodeEditorView wraps NSTextView via NSViewRepresentable
- CLAUDE.md: No external dependencies — regex-based highlighting only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyntaxHighlighter with regex rules for 4 formats</name>
  <files>ClaudeShelf/Utilities/SyntaxHighlighter.swift, ClaudeShelf.xcodeproj/project.pbxproj</files>
  <action>
Create SyntaxHighlighter.swift in Utilities/. This provides regex-based syntax coloring:

1. **SyntaxHighlighter struct** with static methods:
   - `static func highlight(_ text: String, for fileType: FileType) -> NSAttributedString`
   - `static func detectFileType(from filename: String) -> FileType`

2. **FileType enum**: markdown, json, yaml, toml, plainText
   - detectFileType: .md → markdown, .json → json, .yaml/.yml → yaml, .toml → toml, else → plainText

3. **Color theme** (works in both light and dark mode — use NSColor semantic colors):
   - keywords: .systemBlue
   - strings: .systemGreen
   - numbers: .systemOrange
   - comments: .systemGray
   - keys/properties: .systemPurple
   - headings: .systemBrown (bold)
   - links: .systemCyan
   - booleans: .systemPink
   - Base font: .monospacedSystemFont(ofSize: 13, weight: .regular)
   - Base color: .labelColor (adapts to light/dark mode)

4. **Highlighting rules per format:**

   **JSON:**
   - Keys (before colon): `"[^"]+"\s*:` → purple
   - String values: `"[^"]*"` (not followed by :) → green
   - Numbers: `\b-?\d+\.?\d*\b` → orange
   - Booleans/null: `\b(true|false|null)\b` → pink

   **YAML:**
   - Comments: `#.*$` → gray
   - Keys: `^[\w.-]+\s*:` → purple (multiline flag)
   - String values: `"[^"]*"|'[^']*'` → green
   - Numbers: `:\s*-?\d+\.?\d*\s*$` → orange
   - Booleans/null: `\b(true|false|yes|no|null|~)\b` → pink

   **TOML:**
   - Comments: `#.*$` → gray
   - Section headers: `\[[\w.-]+\]` → purple (bold)
   - Keys: `^[\w.-]+\s*=` → purple (multiline)
   - String values: `"[^"]*"|'[^']*'` → green
   - Numbers: `=\s*-?\d+\.?\d*` → orange
   - Booleans: `\b(true|false)\b` → pink

   **Markdown:**
   - Headings: `^#{1,6}\s+.*$` → brown (bold, larger font not needed — just bold)
   - Bold: `\*\*[^*]+\*\*|__[^_]+__` → bold
   - Italic: `\*[^*]+\*|_[^_]+_` → italic (be careful not to match ** or __)
   - Code inline: `` `[^`]+` `` → green with slightly different background
   - Code blocks: ``` ```[\s\S]*?``` ``` → green (multiline)
   - Links: `\[[^\]]+\]\([^)]+\)` → cyan
   - Lists: `^[\s]*[-*+]\s` → blue

   **Plain text:** Just set base font and color, no highlighting

5. Implementation approach:
   - Start with NSMutableAttributedString from full text with base attributes
   - Apply regex matches in order (later matches can override earlier)
   - Use NSRegularExpression with appropriate options (.anchorsMatchLines for ^ patterns)
   - Return NSAttributedString

Add to project.pbxproj with F2 prefix IDs. Add to Utilities group.
  </action>
  <verify>xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | tail -5</verify>
  <done>SyntaxHighlighter.swift exists, builds, provides highlight() method and detectFileType() for all 4 formats</done>
</task>

<task type="auto">
  <name>Task 2: Integrate syntax highlighting into CodeEditorView</name>
  <files>ClaudeShelf/Views/Editor/CodeEditorView.swift, ClaudeShelf/Views/Editor/FileDetailView.swift</files>
  <action>
Wire SyntaxHighlighter into the CodeEditorView:

1. **Add filename property to CodeEditorView:**
   - var filename: String = "" (used to detect file type)

2. **Apply highlighting on initial load:**
   - In makeNSView or updateNSView, when text is set initially, apply SyntaxHighlighter.highlight() to the NSTextStorage
   - Detect file type from filename

3. **Apply highlighting on text changes:**
   - In the Coordinator's textDidChange, re-apply highlighting to changed text
   - For performance: re-highlight the entire text (config files are small — typically <10KB)
   - Use textStorage.beginEditing()/endEditing() for batch attribute changes
   - Preserve the cursor position (selectedRanges) across re-highlighting

4. **Pass filename from FileDetailView:**
   - Update FileDetailView to pass file.name to CodeEditorView: CodeEditorView(text: $fileContent, isEditable: !file.isReadOnly, filename: file.name)

5. **Handle the re-highlighting carefully:**
   - In Coordinator.textDidChange: save selectedRanges, apply highlight to textStorage, restore selectedRanges
   - Set isUpdating flag before applying highlight to avoid feedback loop with updateNSView

6. Update #Preview blocks to show highlighted content

**Performance note:** Config files are typically <100 lines. Full re-highlight on every keystroke is fine. No need for incremental highlighting.
  </action>
  <verify>xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | tail -5</verify>
  <done>Syntax highlighting active for JSON, YAML, TOML, and Markdown files in the editor, colors update on typing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds without errors
- [ ] SyntaxHighlighter detects file types correctly from extension
- [ ] JSON highlighting: keys purple, strings green, numbers orange, booleans pink
- [ ] YAML highlighting: comments gray, keys purple, strings green
- [ ] TOML highlighting: section headers purple bold, comments gray
- [ ] Markdown highlighting: headings bold, code green, links cyan
- [ ] Highlighting updates on text changes without losing cursor position
- [ ] All 40 existing tests pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors or warnings introduced
- 4 file formats highlighted with appropriate colors
- Highlighting updates dynamically as user types
</success_criteria>

<output>
After completion, create `.planning/phases/04-editor/04-02-SUMMARY.md`
</output>
