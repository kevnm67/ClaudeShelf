---
phase: 04-editor
plan: 03
type: execute
---

<objective>
Add undo/redo, Cmd+S save with permission preservation, diff view for unsaved changes, and read-only detection with lock indicator.

Purpose: Complete the editor with save functionality (respecting file permissions per CLAUDE.md safety rules), dirty state tracking, and a diff view showing what changed before committing a save.
Output: Cmd+S save flow, undo/redo menu items, dirty indicator, diff sheet, and read-only lock state.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/04-editor/04-01-SUMMARY.md
@.planning/phases/04-editor/04-02-SUMMARY.md

# Key source files:
@ClaudeShelf/App/AppState.swift
@ClaudeShelf/App/ContentView.swift
@ClaudeShelf/App/ClaudeShelfApp.swift
@ClaudeShelf/Views/Editor/FileDetailView.swift
@ClaudeShelf/Views/Editor/CodeEditorView.swift
@ClaudeShelf/Models/FileEntry.swift

**Tech stack available:** SwiftUI, AppKit (NSTextView with built-in undoManager), Swift 6, Foundation (FileManager, POSIX permissions)
**Established patterns:** NSViewRepresentable, @Observable + @MainActor, .task(id:) for async loading
**Constraining decisions:**
- [04-01]: CodeEditorView wraps NSTextView (has built-in allowsUndo)
- [04-01]: FileDetailView stores originalContent and fileContent as separate @State
- CLAUDE.md: Permission-preserving save — read POSIX before write, restore after. New files default to 0600. Never expose raw paths in errors.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add save functionality with permission preservation and dirty tracking</name>
  <files>ClaudeShelf/Views/Editor/FileDetailView.swift, ClaudeShelf/App/ContentView.swift</files>
  <action>
Add save flow to FileDetailView:

1. **Dirty state detection:**
   - Add computed property: var isDirty: Bool { isLoaded && fileContent != originalContent }
   - Show a dot/badge indicator next to file name in header when isDirty (small circle filled with accent color)

2. **Save method on FileDetailView:**
   - func saveFile():
     a. Read current POSIX permissions: FileManager.default.attributesOfItem(atPath:)[.posixPermissions]
     b. Write content: try fileContent.write(toFile: file.path, atomically: true, encoding: .utf8)
     c. Restore permissions: FileManager.default.setAttributes([.posixPermissions: savedPermissions], ofItemAtPath:)
     d. Update originalContent = fileContent (clears dirty state)
     e. On error: set a @State var saveError: String? with user-friendly message ("Unable to save file"), log details with os.Logger
   - Wrap in do/catch, never expose raw paths

3. **Cmd+S keyboard shortcut:**
   - Add .keyboardShortcut("s", modifiers: .command) on a save Button in the FileDetailView toolbar or header area
   - Only enabled when isDirty && !file.isReadOnly
   - Button shows "Save" with diskette icon (square.and.arrow.down)
   - Alternatively, add it to the toolbar in ContentView — but FileDetailView is better since it owns the state

4. **Save error display:**
   - If saveError is set, show an .alert modifier on FileDetailView with the error message
   - Dismiss clears saveError

5. **Read-only enforcement:**
   - When file.isReadOnly: CodeEditorView(isEditable: false) is already set from 04-01
   - Add a subtle banner below header saying "This file is read-only" with lock icon and secondary styling
   - Save button should not appear for read-only files

6. **Undo/Redo:**
   - NSTextView already supports undo/redo via allowsUndo = true (set in 04-01)
   - Cmd+Z and Cmd+Shift+Z work automatically through NSTextView's undoManager
   - No additional code needed — verify it works

Update #Preview
  </action>
  <verify>xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | tail -5</verify>
  <done>Cmd+S saves file with permission preservation, dirty indicator shows on unsaved changes, undo/redo works, read-only files show lock banner</done>
</task>

<task type="auto">
  <name>Task 2: Add diff view showing unsaved changes</name>
  <files>ClaudeShelf/Views/Editor/DiffView.swift, ClaudeShelf/Views/Editor/FileDetailView.swift, ClaudeShelf.xcodeproj/project.pbxproj</files>
  <action>
Create a simple diff view that shows changes before saving:

1. **DiffView.swift** in Views/Editor/:
   - Takes original: String and modified: String as parameters
   - Computes a simple line-by-line diff:
     a. Split both into lines
     b. Compare lines: unchanged (gray), added (green background), removed (red background with strikethrough)
     c. Use a simple LCS (longest common subsequence) or just line-by-line comparison
     d. For simplicity: use a basic approach — iterate lines in both, mark removed from original and added in modified
   - Display in a ScrollView with monospaced font:
     - Removed lines: red text with "−" prefix, light red background
     - Added lines: green text with "+" prefix, light green background
     - Unchanged lines: normal text with " " prefix
   - Header showing "N lines changed" summary
   - "Save" and "Cancel" buttons at bottom
   - Include #Preview

   **Simple diff algorithm (sufficient for config files):**
   Rather than full LCS, use Foundation's `diff` on line collections:
   - In Swift 5.7+, Array has a .difference(from:) method that returns CollectionDifference
   - Use this to compute insertions and removals
   - This gives correct diff output for line arrays

2. **Wire DiffView into FileDetailView:**
   - Add @State var showDiff: Bool = false
   - Add a "Review Changes" button next to Save button (only visible when isDirty)
   - Button icon: arrow.left.arrow.right or doc.text.magnifyingglass
   - .sheet(isPresented: $showDiff) { DiffView(original: originalContent, modified: fileContent, onSave: saveFile, onCancel: { showDiff = false }) }
   - DiffView's onSave callback: calls saveFile() then dismisses

3. Add DiffView.swift to project.pbxproj with F3 prefix IDs. Add to Editor group.

Update #Preview blocks.
  </action>
  <verify>xcodebuild build -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS' 2>&1 | tail -5</verify>
  <done>DiffView shows line-by-line diff with color coding, accessible via "Review Changes" button, can save or cancel from diff view</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds without errors
- [ ] Cmd+S saves file and preserves POSIX permissions
- [ ] Dirty indicator shows when content differs from original
- [ ] Undo/Redo works via Cmd+Z and Cmd+Shift+Z
- [ ] Read-only files show lock banner and non-editable editor
- [ ] DiffView shows added/removed/unchanged lines with color coding
- [ ] "Review Changes" button opens diff sheet
- [ ] Save from diff view works
- [ ] Save errors shown as user-friendly alerts (no raw paths)
- [ ] All existing tests pass: `xcodebuild test -project ClaudeShelf.xcodeproj -scheme ClaudeShelf -destination 'platform=macOS'`
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors or warnings introduced
- Complete editor with save, undo/redo, diff view, read-only detection
- Permission-preserving save per CLAUDE.md safety rules
- Phase 4 Editor complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-editor/04-03-SUMMARY.md`
</output>
